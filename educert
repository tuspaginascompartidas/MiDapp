<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CertiChain | Prueba de Concepto</title>
    <!-- Carga de Tailwind CSS para estilos rápidos y responsivos --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración para usar la fuente Inter --><style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            max-width: 90%;
            width: 500px;
        }
        /* Estilo para el botón de archivo simulado */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-indigo-700 shadow-md p-4 text-white">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold tracking-tight">CertiChain <span class="text-indigo-200 text-sm italic">PoC</span></h1>
            <nav>
                <button id="nav-upload-btn" onclick="showView('upload')" class="hidden px-4 py-2 text-sm font-medium rounded-lg hover:bg-indigo-600 transition duration-150">
                    Subir Certificado
                </button>
                <!-- El botón Validar Certificado se ha movido a la vista de Acceso (login-view) para acceso público -->
                <!-- El botón Salir se ha movido al interior de la vista de carga -->
            </nav>
        </div>
    </header>

    <main class="flex-grow flex items-center justify-center p-4">
        <div id="app-container" class="container-card bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100">

            <!-- 1. VISTA DE INICIO DE SESIÓN (LOGIN) --><div id="login-view" class="view">
                <h2 class="text-3xl font-extrabold text-gray-900 text-center mb-6">Acceso Universidad</h2>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">Usuario</label>
                        <input type="text" id="username" value="admin" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                        <input type="password" id="password" value="12345" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                        Ingresar
                    </button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-500">
                    Credenciales de prueba: admin / 12345
                </p>
                <!-- Botón de Validar Certificado (solo visible en esta vista para acceso público) -->
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <button type="button" onclick="showView('validate')" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                        Validar Certificado (Público)
                    </button>
                </div>
            </div>

            <!-- 2. VISTA DE CARGA DE CERTIFICADO (UPLOAD) --><div id="upload-view" class="view hidden">
                <h2 class="text-3xl font-extrabold text-gray-900 text-center mb-6">Subir Certificado a Blockchain</h2>
                <form id="upload-form" class="space-y-4">
                    <div>
                        <label for="cert-name" class="block text-sm font-medium text-gray-700">Nombre del Certificado</label>
                        <input type="text" id="cert-name" required placeholder="Ej: Ingeniero de Sistemas" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Nombre del Alumno</label>
                        <input type="text" id="student-name" required placeholder="Ej: Juan Pérez García" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="student-id" class="block text-sm font-medium text-gray-700">Cédula / ID de Alumno</label>
                        <input type="text" id="student-id" required placeholder="Ej: 123456789" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div class="file-input-wrapper w-full">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Archivo de Certificado (PDF/PNG)</label>
                        <button type="button" id="file-btn" class="w-full text-left py-2 px-4 border border-gray-300 rounded-lg bg-gray-50 hover:bg-gray-100 text-gray-700 transition duration-150">
                            Seleccionar Archivo...
                        </button>
                        <input type="file" id="cert-file" accept=".pdf,.png" required onchange="document.getElementById('file-btn').textContent = this.files[0].name">
                    </div>

                    <div id="upload-actions" class="space-y-4 pt-4">
                        <button type="button" id="connect-wallet-btn" onclick="connectWallet()" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                            Conectar Wallet
                        </button>
                        <p id="wallet-status" class="text-center text-sm font-semibold text-green-700 hidden">
                            <span class="inline-flex items-center">
                                <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                                Wallet Conectada: 0x...b1C5
                            </span>
                        </p>

                        <button type="button" id="submit-blockchain-btn" onclick="submitToBlockchain()" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-indigo-600 opacity-50 cursor-not-allowed transition duration-150" disabled>
                            Subir a Blockchain
                        </button>
                    </div>
                </form>
                
                <!-- Nuevo botón Salir, permanente en la vista de carga -->
                <button type="button" onclick="logout()" class="w-full flex justify-center py-2 px-4 mt-6 border border-transparent rounded-lg text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 transition duration-150">
                    Salir
                </button>
            </div>

            <!-- 3. VISTA DE VALIDACIÓN (VALIDATE) --><div id="validate-view" class="view hidden">
                <h2 class="text-3xl font-extrabold text-gray-900 text-center mb-6">Validación de Certificado (NFT)</h2>
                <form id="validate-form" class="space-y-6">
                    <div>
                        <label for="validation-hash" class="block text-sm font-medium text-gray-700">Hash de Registro / Lectura QR</label>
                        <input type="text" id="validation-hash" required placeholder="Ej: 0x7aA3aC1Ff4B92B08f7A1eB90b561c2E5E8A9b1C5" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                        Validar
                    </button>
                </form>
                
                <!-- Botón para regresar al Login/Acceso de Universidad -->
                <button type="button" onclick="showView('login')" class="w-full flex justify-center py-3 px-4 mt-4 border border-indigo-600 rounded-lg shadow-sm text-lg font-medium text-indigo-600 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                    ← Regresar al Acceso de Universidad
                </button>

                <div id="validation-result" class="mt-8 p-6 bg-gray-50 border border-gray-200 rounded-xl hidden">
                    <h3 class="text-xl font-bold text-green-700 mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        ¡Certificado Válido!
                    </h3>
                    <dl class="space-y-3 text-sm text-gray-700">
                        <div class="flex justify-between">
                            <dt class="font-medium">Nombre del Certificado:</dt>
                            <dd id="v-cert-name" class="font-semibold text-gray-900">Ingeniero de Sistemas</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="font-medium">Nombre del Alumno:</dt>
                            <dd id="v-student-name" class="font-semibold text-gray-900">Juan Pérez García</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="font-medium">Cédula / ID:</dt>
                            <dd id="v-student-id" class="font-semibold text-gray-900">123456789</dd>
                        </div>
                        <hr class="border-gray-300 my-2">
                        <div class="flex justify-between">
                            <dt class="font-medium">Entidad Emisora:</dt>
                            <dd id="v-uploader" class="text-indigo-600 font-medium">Universidad de Pruebas</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="font-medium">Fecha de Registro (Blockchain):</dt>
                            <dd id="v-date" class="font-mono">2025-10-27 10:30:00</dd>
                        </div>
                        <div class="flex justify-between items-center bg-yellow-100 p-2 rounded-lg mt-3">
                            <dt class="font-medium text-yellow-800">Hash de la Transacción:</dt>
                            <dd id="v-hash" class="font-mono text-xs text-yellow-800 break-all">0x7aA3aC1Ff4B92B08f7A1eB90b561c2E5E8A9b1C5</dd>
                        </div>
                    </dl>
                </div>

                <div id="validation-error" class="mt-8 p-6 bg-red-100 border border-red-300 rounded-xl hidden">
                    <h3 class="text-xl font-bold text-red-700 mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Hash No Encontrado
                    </h3>
                    <p class="text-sm text-red-700">El hash ingresado no corresponde a un certificado válido registrado en nuestra simulación de Blockchain. Verifique el código o QR.</p>
                </div>
            </div>

            <!-- MODAL DE ÉXITO (Simulación de QR y Hash) --><div id="success-modal" onclick="closeModal()" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
                <div onclick="event.stopPropagation()" class="bg-white p-8 rounded-xl shadow-3xl max-w-lg w-full transform transition-all duration-300 scale-100">
                    <h3 class="text-2xl font-extrabold text-indigo-700 text-center mb-6">¡Registro Exitoso en Blockchain! (Simulación)</h3>

                    <p class="text-center text-gray-700 mb-6">Este es el **Hash del Registro NFT** y su **Código QR** correspondiente, únicos para el certificado de <span id="modal-cert-name" class="font-semibold text-indigo-600"></span>.</p>

                    <!-- Imagen del QR Code Válido --><div class="flex justify-center mb-6">
                        <div class="p-4 bg-white border border-gray-300 rounded-lg shadow-md">
                            <img id="qr-code-img" src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=0x7aA3aC1Ff4B92B08f7A1eB90b561c2E5E8A9b1C5" alt="Código QR del Hash" class="w-40 h-40"/>
                        </div>
                    </div>

                    <div class="p-4 bg-gray-100 rounded-lg text-center break-all">
                        <p class="text-xs font-medium text-gray-500 uppercase">Hash de Registro (NFT ID)</p>
                        <code id="modal-hash" class="text-base font-mono font-bold text-gray-800">0x7aA3aC1Ff4B92B08f7A1eB90b561c2E5E8A9b1C5</code>
                    </div>

                    <button onclick="closeModal()" class="w-full flex justify-center mt-6 py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                        Cerrar
                    </button>
                </div>
            </div>

        </div>
    </main>

    <!-- PIE DE PÁGINA REQUERIDO --><footer class="p-4 bg-gray-200 text-center text-gray-600 text-sm border-t border-gray-300">
        <p>
            Esta es una prueba de concepto y no se encuentra conectada a una red Blockchain real.
        </p>
    </footer>

    <script>
        // --- VARIABLES GLOBALES DE ESTADO ---
        let currentView = 'login';
        let walletConnected = false;
        
        // Arreglo que simula el almacenamiento de registros en la "Blockchain"
        let certificateRecords = [
            // Registro inicial de ejemplo (para facilitar la primera prueba de validación)
            {
                hash: "0x7aA3aC1Ff4B92B08f7A1eB90b561c2E5E8A9b1C5",
                certName: "Ingeniero de Sistemas",
                studentName: "Juan Pérez García",
                studentId: "123456789",
                uploader: "Universidad de Pruebas",
                // MODIFICADO: Incluye fecha y hora
                uploadDate: "2025-10-27 10:30:00" 
            }
        ];

        // Función para generar un hash hexadecimal aleatorio (simulación de ID Blockchain)
        function generateRandomHash() {
            // Genera una cadena hexadecimal de 40 caracteres con prefijo 0x
            const hex = [...Array(40)].map(() => Math.floor(Math.random() * 16).toString(16)).join('');
            return `0x${hex.toUpperCase()}`;
        }

        // --- MANEJO DE VISTAS Y AUTENTICACIÓN ---

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(`${viewId}-view`).classList.remove('hidden');
            currentView = viewId;
            
            // LÓGICA AGREGADA: Limpiar el campo de validación y resultados al entrar a la vista 'validate'
            if (viewId === 'validate') {
                document.getElementById('validation-hash').value = ''; 
                document.getElementById('validation-result').classList.add('hidden');
                document.getElementById('validation-error').classList.add('hidden');
            }

            // Actualizar visibilidad de botones de navegación en el header
            const isLoggedIn = (viewId === 'upload'); // Solo está "loggeado" si está en la vista de subir
            
            // nav-upload-btn (Visible solo cuando está loggeado)
            document.getElementById('nav-upload-btn').classList.toggle('hidden', !isLoggedIn);
            document.getElementById('nav-upload-btn').classList.toggle('inline-block', isLoggedIn);
        }

        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'admin' && password === '12345') {
                showView('upload');
            } else {
                alertUser("Usuario o contraseña incorrectos.", "error");
            }
        });

        function logout() {
            walletConnected = false;
            
            resetUploadForm();
            document.getElementById('login-form').reset(); // Limpiar campos del login
            showView('login'); // Regresar a la pantalla de Acceso Universidad
            alertUser("Sesión cerrada correctamente.", "info");
        }

        // --- FUNCIONALIDAD DE CARGA ---

        function updateSubmitButton() {
            const certName = document.getElementById('cert-name').value;
            const studentName = document.getElementById('student-name').value;
            const studentId = document.getElementById('student-id').value;
            const certFile = document.getElementById('cert-file').files.length > 0;
            const canSubmit = certName && studentName && studentId && certFile && walletConnected;

            const submitBtn = document.getElementById('submit-blockchain-btn');
            submitBtn.disabled = !canSubmit;
            submitBtn.classList.toggle('opacity-50', !canSubmit);
            submitBtn.classList.toggle('cursor-not-allowed', !canSubmit);
            submitBtn.classList.toggle('bg-indigo-600', canSubmit);
            submitBtn.classList.toggle('hover:bg-indigo-700', canSubmit);
        }

        document.getElementById('upload-form').addEventListener('input', updateSubmitButton);
        document.getElementById('upload-form').addEventListener('change', updateSubmitButton);


        function connectWallet() {
            // Simulación de conexión a Wallet
            const connectBtn = document.getElementById('connect-wallet-btn');
            const statusText = document.getElementById('wallet-status');

            connectBtn.disabled = true;
            connectBtn.textContent = 'Conectando...';

            setTimeout(() => {
                walletConnected = true;
                connectBtn.classList.add('hidden');
                statusText.classList.remove('hidden');
                updateSubmitButton();
                alertUser("Wallet conectada exitosamente (simulación).", "success");
            }, 1500);
        }

        function submitToBlockchain() {
            // 1. Capturar datos del formulario
            const certName = document.getElementById('cert-name').value;
            const studentName = document.getElementById('student-name').value;
            const studentId = document.getElementById('student-id').value;
            
            // 2. Generar Hash y fecha
            const newHash = generateRandomHash();
            
            // MODIFICADO: Generar fecha y hora en formato YYYY-MM-DD HH:MM:SS
            const now = new Date();
            const datePart = now.toISOString().split('T')[0];
            const timePart = now.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false});
            const uploadDate = `${datePart} ${timePart}`;
            
            const newRecord = {
                hash: newHash,
                certName: certName,
                studentName: studentName,
                studentId: studentId,
                uploader: "Universidad de Pruebas", // Simulación del emisor
                uploadDate: uploadDate // Usando el nuevo formato con hora
            };

            const submitBtn = document.getElementById('submit-blockchain-btn');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Subiendo... (Simulación)';
            submitBtn.classList.add('opacity-50');

            setTimeout(() => {
                // 3. Almacenar el nuevo registro en el arreglo global
                certificateRecords.push(newRecord);
                
                // 4. Actualizar la imagen del QR en el modal
                const qrImgElement = document.getElementById('qr-code-img');
                qrImgElement.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(newHash)}`;

                // 5. Mostrar Hash y QR en el modal
                document.getElementById('modal-cert-name').textContent = certName;
                document.getElementById('modal-hash').textContent = newHash;
                document.getElementById('success-modal').classList.remove('hidden');
                document.getElementById('success-modal').classList.add('flex');
                
                alertUser("Certificado registrado (simulación). Hash generado.", "success");
                resetUploadForm(); // Resetear el formulario después de la subida simulada

            }, 2500);
        }

        function closeModal() {
            document.getElementById('success-modal').classList.add('hidden');
            document.getElementById('success-modal').classList.remove('flex');
            
            // Revertir el estado de los botones
            const submitBtn = document.getElementById('submit-blockchain-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Subir a Blockchain';
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            submitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
        }

        function resetUploadForm() {
            document.getElementById('upload-form').reset();
            document.getElementById('file-btn').textContent = 'Seleccionar Archivo...';
            document.getElementById('connect-wallet-btn').classList.remove('hidden');
            document.getElementById('connect-wallet-btn').disabled = false;
            document.getElementById('connect-wallet-btn').textContent = 'Conectar Wallet';
            document.getElementById('wallet-status').classList.add('hidden');
            walletConnected = false;
            updateSubmitButton();
        }

        // --- FUNCIONALIDAD DE VALIDACIÓN ---

        document.getElementById('validate-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const inputHash = document.getElementById('validation-hash').value.trim();
            const resultDiv = document.getElementById('validation-result');
            const errorDiv = document.getElementById('validation-error');

            resultDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');

            // 1. Buscar el hash en el arreglo de registros
            const data = certificateRecords.find(record => record.hash === inputHash);

            if (data) {
                // Hash encontrado, mostrar datos
                document.getElementById('v-cert-name').textContent = data.certName;
                document.getElementById('v-student-name').textContent = data.studentName;
                document.getElementById('v-student-id').textContent = data.studentId;
                document.getElementById('v-uploader').textContent = data.uploader;
                document.getElementById('v-date').textContent = data.uploadDate;
                document.getElementById('v-hash').textContent = data.hash;

                resultDiv.classList.remove('hidden');
                alertUser("Certificado validado exitosamente.", "success");
            } else {
                // Hash no encontrado
                errorDiv.classList.remove('hidden');
                alertUser("Hash no encontrado. Certificado no válido.", "error");
            }
        });

        // --- FUNCIÓN DE ALERTA SIN ALERT() ---
        function alertUser(message, type = "info") {
            const container = document.getElementById('app-container');
            let alertDiv = document.getElementById('custom-alert');

            if (!alertDiv) {
                alertDiv = document.createElement('div');
                alertDiv.id = 'custom-alert';
                alertDiv.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white font-medium z-50 transition-all duration-300 transform opacity-0 translate-y-[-10px]';
                document.body.appendChild(alertDiv);
            }

            const bgColor = type === "success" ? 'bg-green-500' : type === "error" ? 'bg-red-500' : 'bg-blue-500';
            
            alertDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white font-medium z-50 transition-all duration-300 transform opacity-100 translate-y-0 ${bgColor}`;
            alertDiv.textContent = message;

            // Mostrar y luego ocultar
            clearTimeout(alertDiv.timer);
            alertDiv.timer = setTimeout(() => {
                alertDiv.classList.remove('opacity-100', 'translate-y-0');
                alertDiv.classList.add('opacity-0', 'translate-y-[-10px]');
            }, 3000);
        }
        
        // Inicialización: mostrar la vista de Login al cargar
        document.addEventListener('DOMContentLoaded', () => {
            showView('login');
        });
    </script>

</body>
</html>
